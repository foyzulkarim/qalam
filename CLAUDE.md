# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Qalam is a stateless Quran translation learning application. Users practice translating Quranic verses and receive AI-powered feedback. The app has no user authentication or database—all data is served from Cloudflare R2.

## Architecture

```
┌─────────────────────────┐     ┌─────────────────────────┐
│   CLOUDFLARE PAGES      │     │   CLOUDFLARE WORKER     │
│   (Static App + SPA)    │     │   (qalam-api)           │
├─────────────────────────┤     ├─────────────────────────┤
│ Next.js static export   │     │ POST /assess only       │
│ HTML/JS/CSS/fonts       │────▶│ KV caching              │
│ ~200 files total        │     │ LLM API calls           │
│ _redirects for SPA      │     │ (minimal footprint)     │
└─────────────────────────┘     └─────────────────────────┘
          │                              │
          │                              ▼
          │                     ┌─────────────────────────┐
          │                     │   CLOUDFLARE R2         │
          │                     │   (Public Bucket)       │
          │                     ├─────────────────────────┤
          │                     │ quran.json              │
          │                     │ surahs.json             │
          └────────────────────▶│ analysis/*.json (6000+) │
                                └─────────────────────────┘
                                cdn.versemadeeasy.com
```

**Key insights:**
- Data is served directly from public R2 (no Worker hop)
- Verse pages use SPA routing: one shell page serves all 6,236 verses via `_redirects`
- The Worker only handles `/assess` requests that need LLM + KV caching

## Common Commands

```bash
# Development
npm run dev              # Start Next.js dev server (localhost:3000)
npm run worker:dev       # Start Worker locally
npm run build            # Build static export to out/
npm run start            # Serve static build locally
npm run lint             # Run ESLint

# Data Management
npm run build:quran      # Build quran.json from Tanzil.net source files
npm run seed:analysis    # Generate verse analysis via Ollama
npm run upload:r2        # Upload all data files to R2
npm run data:status      # Show analysis generation progress

# Deployment
npm run pages:deploy     # Build & deploy Next.js to Cloudflare Pages
npm run worker:deploy    # Deploy Worker API to Cloudflare
npm run deploy           # Deploy both (Worker + Pages)
```

## Tech Stack
- **Frontend**: Next.js 16 with App Router (static export)
- **API**: Cloudflare Worker
- **Storage**: Cloudflare R2 (data files), KV (assessment cache)
- **Language**: TypeScript (strict mode)
- **Styling**: Tailwind CSS with custom Islamic-themed colors

## Key Directories
- `src/app/` - Next.js App Router pages
- `src/components/ui/` - Reusable UI components
- `src/components/` - Feature components (Navbar, VerseDisplay, FeedbackCard)
- `src/lib/data.ts` - Data fetching utilities (fetches from public R2)
- `src/types/` - TypeScript definitions
- `worker/` - Cloudflare Worker (assessment API only)
- `scripts/` - Utility scripts (R2 upload, analysis seeding)
- `data/` - Local data files (source for R2, not included in build)
- `public/_redirects` - Cloudflare Pages SPA routing rules

## Data Architecture

**Source Data (human-verified, from Tanzil.net):**
- `quran.json` - Complete Quran with Arabic text + translations
- `surahs.json` - Surah metadata
- Built from source files: `quran-simple.txt`, `en.sahih.txt`, `en.transliteration.txt`

**Analysis Data (LLM-generated):**
- `analysis/{surah}-{verse}.json` - Word-by-word linguistic analysis
- Generated locally with `npm run seed:analysis`
- Synced to R2 with `npm run upload:r2`

**Key Principle:** Arabic text and translations are NEVER generated by LLM. Only linguistic analysis is AI-generated.

## Worker API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/assess` | POST | Translation assessment (LLM + KV cache) |
| `/list-bucket` | GET | List files in R2 bucket (for sync & future UI features) |
| `/health` | GET | Health check |

**Note:** Data is served directly from public R2 at `https://cdn.versemadeeasy.com`

## Environment Variables

Frontend (`.env`):
- `NEXT_PUBLIC_R2_URL` - Public R2 URL for data (default: https://cdn.versemadeeasy.com)
- `NEXT_PUBLIC_API_URL` - Worker API URL for assessment (default: https://qalam-api.foyzul.workers.dev)

Worker (via `wrangler secret`):
- `TOGETHER_API_KEY` - Together.ai API key for LLM

## Development Workflow

1. **Local Development**:
   ```bash
   npm run worker:dev   # Start worker locally
   npm run dev          # Start Next.js dev server
   ```

2. **Generate Analysis**:
   ```bash
   npm run seed:analysis  # Generate analysis files locally
   npm run upload:r2      # Upload to R2 (no app redeploy needed!)
   ```

3. **Deploy**:
   - Push to main branch triggers CI/CD
   - Or manually: `npm run worker:deploy` and push to Cloudflare Pages

## Important Types
- `QuranData` - Complete quran.json structure
- `QuranVerse` - Verse with arabic + translations
- `VerseAnalysis` - Word-by-word linguistic analysis
- `AttemptFeedback` - LLM evaluation results

## Design System
- Primary: Teal (#14b8a6) - Islamic aesthetic
- Secondary: Gold (#f59e0b) - accents
- Arabic text: `font-arabic` class with `text-arabic-*` sizes
- RTL support: `dir="rtl"` and `lang="ar"` attributes
