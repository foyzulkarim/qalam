# Qalam: Next.js Implementation Plan

**Version:** 1.1
**Last Updated:** December 2025
**Purpose:** Simple, practical plan for a solo developer learning project

---

## Overview

Qalam is a Quran comprehension learning app. Users practice translating Arabic verses, get AI feedback, and track their progress.

**Key Principle:** Keep it simple. This is a learning project, not a production system.

---

## Technology Stack

| Layer | Choice | Reason |
|-------|--------|--------|
| Framework | Next.js 14+ (App Router) | Single process, handles frontend + backend |
| Database | SQLite + Prisma | No server to manage, great TypeScript support |
| Auth | NextAuth.js v5 | Handles sessions, cookies, security |
| Styling | Tailwind CSS | No CSS files to manage |
| LLM | Ollama (local) | Used for seeding (analysis) and runtime (feedback) |

---

## Project Structure

```
qalam/
├── app/
│   ├── (public)/                 # No auth required
│   │   ├── page.tsx              # Landing page
│   │   ├── login/
│   │   │   └── page.tsx
│   │   └── register/
│   │       └── page.tsx
│   │
│   ├── (protected)/              # Auth required
│   │   ├── layout.tsx            # Checks auth, redirects if not logged in
│   │   ├── practice/
│   │   │   └── page.tsx          # Main practice interface
│   │   ├── progress/
│   │   │   └── page.tsx          # View learning stats
│   │   ├── browse/
│   │   │   └── page.tsx          # Browse all surahs
│   │   └── settings/
│   │       └── page.tsx          # User settings
│   │
│   ├── api/
│   │   ├── auth/[...nextauth]/
│   │   │   └── route.ts          # NextAuth handler
│   │   ├── surahs/
│   │   │   └── route.ts          # GET all surahs
│   │   ├── surahs/[id]/
│   │   │   └── route.ts          # GET single surah with verses
│   │   ├── evaluate/
│   │   │   └── route.ts          # POST - evaluate user's translation
│   │   └── progress/
│   │       └── route.ts          # GET - user's learning stats
│   │
│   └── layout.tsx                # Root layout
│
├── components/
│   ├── Navbar.tsx
│   ├── VerseDisplay.tsx          # Shows Arabic text
│   ├── PracticeForm.tsx          # Input for user's attempt
│   ├── FeedbackCard.tsx          # Shows LLM feedback
│   ├── AnalysisView.tsx          # Shows verse analysis (words, roots, grammar)
│   └── ProgressStats.tsx         # Shows learning stats
│
├── lib/
│   ├── db.ts                     # Prisma client singleton
│   ├── auth.ts                   # NextAuth configuration
│   └── llm.ts                    # LLM API calls
│
├── data/
│   ├── surahs/                   # Quran verse data
│   │   ├── index.json            # List of all 114 surahs (metadata)
│   │   ├── 001.json              # Al-Fatihah verses
│   │   ├── 002.json              # Al-Baqarah verses
│   │   └── ...                   # Remaining surahs
│   │
│   └── analysis/                 # Pre-computed verse analysis (generated by seed)
│       ├── 001.json              # Al-Fatihah analysis
│       ├── 002.json              # Al-Baqarah analysis
│       └── ...                   # Remaining surahs
│
├── prisma/
│   └── schema.prisma
│
├── scripts/
│   └── seed.ts                   # Generates verse analysis via LLM
│
├── public/                       # Static assets
├── package.json
├── tailwind.config.ts
├── tsconfig.json
└── .env.local                    # Environment variables (gitignored)
```

---

## Data Preparation vs Runtime

### Before App Runs (Manual, One-Time)

```
npm run seed
    │
    ├── Calls local LLM (Ollama) for each verse
    ├── Generates linguistic analysis (words, roots, grammar)
    ├── Saves to /data/analysis/*.json
    └── These files are committed to the repo
```

### At Runtime (Per User Request)

```
User submits translation attempt
    │
    ├── Load pre-computed analysis from /data/analysis/
    ├── Send to LLM: user input + analysis + correct translation
    ├── LLM returns feedback (score + explanation)
    ├── Save attempt to SQLite database
    └── Display feedback + analysis to user
```

---

## Database Schema

Two tables only (user data, not verse data):

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./qalam.db"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // hashed
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  attempts  Attempt[]
}

model Attempt {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Verse identification
  surahId   Int      // 1-114
  verseNum  Int      // Verse number within surah
  verseId   String   // "1:2" format for easy querying

  // User's attempt
  userInput String
  skipped   Boolean  @default(false)

  // LLM feedback
  score     Int      // 0-100
  feedback  String   // LLM's feedback text

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([verseId])
}
```

---

## Data Formats

### Surah Data (source Quran text)

```json
// data/surahs/001.json
{
  "id": 1,
  "name": "Al-Fatihah",
  "arabicName": "الفاتحة",
  "versesCount": 7,
  "verses": [
    {
      "number": 1,
      "arabic": "بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ",
      "translation": "In the name of Allah, the Most Gracious, the Most Merciful."
    },
    {
      "number": 2,
      "arabic": "الْحَمْدُ لِلَّهِ رَبِّ الْعَالَمِينَ",
      "translation": "All praise is due to Allah, Lord of the worlds."
    }
    // ... remaining verses
  ]
}
```

### Verse Analysis (generated by seed script)

```json
// data/analysis/001.json
{
  "surahId": 1,
  "verses": [
    {
      "verseNumber": 1,
      "words": [
        {
          "arabic": "بِسْمِ",
          "transliteration": "bismi",
          "meaning": "In the name of",
          "root": "س م و",
          "grammar": "preposition + noun (genitive)"
        },
        {
          "arabic": "اللَّهِ",
          "transliteration": "allahi",
          "meaning": "Allah",
          "root": "أ ل ه",
          "grammar": "proper noun (genitive)"
        }
        // ... remaining words
      ],
      "grammarNotes": [
        "The phrase begins with the preposition 'bi' (in/with)",
        "All nouns are in the genitive case due to the preposition"
      ]
    }
    // ... remaining verses
  ]
}
```

### Surah Index

```json
// data/surahs/index.json
[
  { "id": 1, "name": "Al-Fatihah", "arabicName": "الفاتحة", "versesCount": 7 },
  { "id": 2, "name": "Al-Baqarah", "arabicName": "البقرة", "versesCount": 286 }
  // ... all 114 surahs
]
```

---

## Core User Flow

```
1. User visits app
   └── Not logged in → Show landing page with login/register

2. User logs in (NextAuth handles this)
   └── Redirected to /practice

3. Practice page
   ├── Shows a verse (Arabic text only)
   ├── User types their translation attempt
   ├── Clicks "Submit"
   │
   └── POST /api/evaluate
       ├── Load pre-computed analysis from JSON
       ├── Send to LLM: user input + analysis + correct translation
       ├── LLM returns score (0-100) + feedback
       ├── Save attempt to database
       └── Return feedback + analysis to user

4. User sees results
   ├── Score and feedback (what they got right/wrong)
   ├── Correct translation revealed
   ├── Full analysis (word breakdown, roots, grammar)
   └── "Next Verse" button

5. Progress page
   └── Shows stats: verses attempted, average score, history
```

---

## API Routes

### GET /api/surahs
Returns list of all surahs (from index.json)

### GET /api/surahs/[id]
Returns single surah with all verses

### POST /api/evaluate
```typescript
// Request
{
  surahId: number,
  verseNum: number,
  userInput: string
}

// Response
{
  score: number,              // 0-100
  feedback: string,           // LLM explanation of what user got right/wrong
  correctTranslation: string,
  analysis: {                 // Pre-computed, loaded from JSON
    words: [...],
    grammarNotes: [...]
  }
}
```

### GET /api/progress
Returns user's learning statistics

---

## LLM Integration

Two uses of LLM:

### 1. Seed Script (one-time, generates analysis)

```typescript
// scripts/seed.ts

async function generateVerseAnalysis(verse: Verse) {
  const prompt = `
    Analyze this Quranic verse word by word:

    Arabic: ${verse.arabic}
    Translation: ${verse.translation}

    For each word provide:
    - Arabic word
    - Transliteration
    - Meaning
    - Root letters
    - Grammar notes

    Respond in JSON format.
  `;

  // Call local Ollama
  const response = await fetch('http://localhost:11434/api/generate', {
    method: 'POST',
    body: JSON.stringify({ model: 'llama2', prompt })
  });

  return response.json();
}
```

### 2. Runtime (per user request, generates feedback)

```typescript
// lib/llm.ts

export async function evaluateTranslation(
  userInput: string,
  correctTranslation: string,
  arabicText: string,
  analysis: VerseAnalysis  // Pre-computed, loaded from JSON
): Promise<{ score: number; feedback: string }> {

  const prompt = `
    Compare the user's translation attempt to the correct translation.

    Arabic verse: ${arabicText}
    Correct translation: ${correctTranslation}
    User's attempt: ${userInput}

    Word analysis for context:
    ${JSON.stringify(analysis.words)}

    Rate accuracy 0-100 and give brief, encouraging feedback.
    Mention specific words they got right or missed.

    Respond in JSON: { "score": number, "feedback": "string" }
  `;

  const response = await fetch(process.env.LLM_API_URL, {
    method: 'POST',
    body: JSON.stringify({ prompt })
  });

  return response.json();
}
```

---

## Environment Variables

```bash
# .env.local

# Database
DATABASE_URL="file:./prisma/qalam.db"

# NextAuth
NEXTAUTH_SECRET="generate-a-random-string"
NEXTAUTH_URL="http://localhost:3000"

# LLM
LLM_API_URL="http://localhost:11434/api/generate"
LLM_MODEL="llama2"
```

---

## NPM Scripts

```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",

    "seed": "tsx scripts/seed.ts",

    "db:migrate": "npx prisma migrate dev",
    "db:push": "npx prisma db push",
    "db:studio": "npx prisma studio",
    "db:generate": "npx prisma generate"
  }
}
```

| Command | Purpose |
|---------|---------|
| `npm run seed` | Generate verse analysis JSONs via local LLM |
| `npm run db:migrate` | Apply Prisma schema changes (create/update tables) |
| `npm run db:push` | Push schema to DB without migration files |
| `npm run db:studio` | Open Prisma GUI to browse data |
| `npm run db:generate` | Regenerate Prisma client after schema changes |

---

## Setup Workflow

### First Time Setup

```bash
# 1. Clone repo and install dependencies
git clone <repo>
cd qalam
npm install

# 2. Set up database
npm run db:migrate

# 3. Generate verse analysis (run local Ollama first)
ollama run llama2  # Start Ollama with a model
npm run seed       # Generate analysis JSONs

# 4. Start development
npm run dev
```

### After Pulling Updates

```bash
npm install                 # Get new dependencies
npm run db:migrate          # Apply any schema changes
npm run dev                 # Start development
```

---

## Implementation Phases

### Phase 1: Setup (Foundation)
- [ ] Create Next.js project with Tailwind
- [ ] Set up Prisma with SQLite
- [ ] Configure NextAuth.js (email/password)
- [ ] Create basic layout with Navbar
- [ ] Add login/register pages

### Phase 2: Data
- [ ] Add Quran JSON files to /data/surahs
- [ ] Create seed script for verse analysis
- [ ] Run seed to generate /data/analysis files
- [ ] Commit analysis files to repo
- [ ] Create API route: GET /api/surahs
- [ ] Create API route: GET /api/surahs/[id]
- [ ] Create browse page (list all surahs)

### Phase 3: Practice (Core Feature)
- [ ] Create practice page UI
- [ ] Set up runtime LLM integration
- [ ] Create API route: POST /api/evaluate
- [ ] Load and pass pre-computed analysis to LLM
- [ ] Save attempts to database
- [ ] Show feedback + analysis to user

### Phase 4: Progress
- [ ] Create API route: GET /api/progress
- [ ] Build progress dashboard page
- [ ] Show attempt history
- [ ] Display stats (verses practiced, average score)

### Phase 5: Polish
- [ ] Settings page (update name, password)
- [ ] Better error handling
- [ ] Loading states
- [ ] Mobile responsiveness

---

## Data Source

For Quran data, you can use open datasets:
- [quran-json](https://github.com/risan/quran-json) - Simple JSON format
- [Tanzil.net](http://tanzil.net/download) - Multiple translations
- [Al Quran Cloud API](https://alquran.cloud/api) - REST API

Pick one translation you trust and convert to the format above.

---

## Deployment (When Ready)

Simple deployment to a VPS:

1. Build: `npm run build`
2. Copy files to server (including /data/analysis/)
3. Run with PM2 or systemd
4. Nginx reverse proxy
5. SSL with Let's Encrypt

Or even simpler: Deploy to Vercel (free tier works)

Note: The analysis JSON files are committed to the repo, so they deploy automatically.

---

## What's NOT in This Plan

Keeping it simple means skipping:
- ❌ Complex caching
- ❌ OAuth providers (just email/password for now)
- ❌ Admin dashboard
- ❌ Multiple translations
- ❌ Offline support

These can be added later if needed.

---

## Summary

| Aspect | Decision |
|--------|----------|
| Single or separate apps? | Single (Next.js) |
| Database | SQLite + Prisma (user data only) |
| Auth | NextAuth.js |
| Styling | Tailwind CSS |
| Verse analysis | Pre-computed via seed, stored as JSON in repo |
| Runtime LLM | Feedback only (uses pre-computed analysis) |
| Complexity | Minimal |

**Start simple. Learn. Iterate.**
