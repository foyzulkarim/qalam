# Database Schema & Data Formats

---

## Prisma Schema

Two tables only (user data, not verse data):

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./qalam.db"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // hashed with bcrypt
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  attempts  Attempt[]
}

model Attempt {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Verse identification
  surahId   Int      // 1-114
  verseNum  Int      // Verse number within surah
  verseId   String   // "1:2" format for easy querying

  // User's attempt
  userInput String
  skipped   Boolean  @default(false)

  // LLM feedback (structured for UI display)
  score      Int      // 0-100
  summary    String   // Brief feedback sentence
  gotCorrect String   // JSON array: ["Praise to Allah", "Lord of worlds"]
  missed     String   // JSON array: ["the word 'due'"]
  insight    String?  // Optional teaching moment about roots/grammar

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([verseId])
  @@index([userId, verseId])  // Composite for verse history queries
}
```

---

## Data Files

### Surah Index

```json
// data/surahs/index.json
[
  { "id": 1, "name": "Al-Fatihah", "arabicName": "الفاتحة", "versesCount": 7 },
  { "id": 2, "name": "Al-Baqarah", "arabicName": "البقرة", "versesCount": 286 }
  // ... all 114 surahs
]
```

### Surah Data

```json
// data/surahs/001.json
{
  "id": 1,
  "name": {
    "arabic": "الفاتحة",
    "transliteration": "Al-Fatihah",
    "english": "The Opening"
  },
  "revelation": "meccan",
  "verseCount": 7,
  "verses": [
    {
      "id": "1:1",
      "number": 1,
      "arabic": "بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ",
      "translation": "In the name of Allah, the Most Gracious, the Most Merciful."
    }
    // ... remaining verses
  ]
}
```

### Verse Analysis (Generated by Seed)

```json
// data/analysis/001.json
{
  "surahId": 1,
  "surahName": "Al-Fatihah",
  "generatedAt": "2025-12-22T10:30:00Z",
  "model": "llama2",
  "verses": [
    {
      "verseNumber": 1,
      "words": [
        {
          "arabic": "بِسْمِ",
          "transliteration": "bismi",
          "meaning": "In the name of",
          "root": "س م و",
          "grammar": "preposition + noun (genitive)"
        },
        {
          "arabic": "اللَّهِ",
          "transliteration": "allahi",
          "meaning": "Allah",
          "root": "أ ل ه",
          "grammar": "proper noun (genitive)"
        }
        // ... remaining words
      ],
      "grammarNotes": [
        "The phrase begins with the preposition 'bi' (in/with)",
        "All nouns are in the genitive case due to the preposition"
      ]
    }
    // ... remaining verses
  ]
}
```

---

## TypeScript Types

```typescript
// types/index.ts

interface User {
  id: string;
  email: string;
  name: string | null;
  createdAt: Date;
  updatedAt: Date;
}

interface Attempt {
  id: string;
  userId: string;
  surahId: number;
  verseNum: number;
  verseId: string;
  userInput: string;
  skipped: boolean;
  score: number;
  summary: string;
  gotCorrect: string;  // JSON string, parse to string[]
  missed: string;      // JSON string, parse to string[]
  insight: string | null;
  createdAt: Date;
}

interface Verse {
  id: string;
  number: number;
  arabic: string;
  translation: string;
}

interface Surah {
  id: number;
  name: {
    arabic: string;
    transliteration: string;
    english: string;
  };
  revelation: 'meccan' | 'medinan';
  verseCount: number;
  verses: Verse[];
}

interface WordAnalysis {
  arabic: string;
  transliteration: string;
  meaning: string;
  root: string;
  grammar: string;
}

interface VerseAnalysis {
  verseNumber: number;
  words: WordAnalysis[];
  grammarNotes: string[];
}
```

---

## Database Commands

```bash
# Create/update database from schema
npm run db:migrate

# Push schema changes without migration files (dev only)
npm run db:push

# Open Prisma Studio to browse data
npm run db:studio

# Regenerate Prisma client after schema changes
npm run db:generate
```
